<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠n di·ªán Ng√¥n ng·ªØ K√Ω hi·ªáu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #2e86de;
            --text-color: #2c3e50;
            --bg-color: linear-gradient(135deg, #f0f8ff, #dff9fb);
            --card-bg: #ffffff;
            --border-color: #ccc;
        }

        body.dark {
            --primary-color: #00a8ff;
            --text-color: #f5f6fa;
            --bg-color: #2f3640;
            --card-bg: #353b48;
            --border-color: #555;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            margin: 0;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
        }

        h1 {
            text-align: center;
            font-size: 32px;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        .section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            transition: background 0.3s;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #1e6ab0;
        }

        video, img {
            border-radius: 10px;
            border: 2px solid var(--border-color);
            max-width: 100%;
            height: auto;
        }

        .result ul {
            list-style-type: none;
            padding-left: 0;
        }

        .result ul li {
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 17px;
            color: var(--text-color);
        }

        #resultText {
            font-size: 18px;
            font-style: italic;
            color: #c0392b;
        }

        .toggle-mode {
            text-align: center;
            margin-bottom: 20px;
        }

        .toggle-mode button {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .toggle-mode button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        @media (max-width: 768px) {
            button {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        form {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
    </style>
</head>
<body>
    <h1>üñêÔ∏è NH·∫¨N DI·ªÜN NG√îN NG·ªÆ K√ù HI·ªÜU T·ª™ H√åNH ·∫¢NH HO·∫∂C CAMERA</h1>

    <div class="toggle-mode">
        <button onclick="toggleDarkMode()">üåô B·∫≠t / T·∫Øt Dark Mode</button>
    </div>

    <!-- Ph·∫ßn D·ª± ƒëo√°n t·ª´ ·∫£nh upload -->
    <div class="section">
        <h2>1Ô∏è‚É£ D·ª± ƒëo√°n t·ª´ ·∫£nh upload:</h2>
        <form method="POST" enctype="multipart/form-data">
            <input type="file" name="file" accept="image/*" required>
            <button type="submit">T·∫£i l√™n & D·ª± ƒëo√°n</button>
        </form>

        {% if prediction %}
            <div class="result">
                <h3>K·∫øt qu·∫£ d·ª± ƒëo√°n:</h3>
                {% if prediction == "No hand detected" %}
                    <p style="color: red;">üö´ Kh√¥ng ph√°t hi·ªán b√†n tay trong ·∫£nh.</p>
                {% else %}
                    <ul>
                        {% for label, prob in prediction %}
                            <li>‚û°Ô∏è <strong>{{ label }}</strong> ‚Äì {{ '%.2f' % prob }}%</li>
                        {% endfor %}
                    </ul>
                    <h4>·∫¢nh sau x·ª≠ l√Ω:</h4>
                    <img src="{{ url_for('static', filename='uploads/' + filename) }}" width="200">
                {% endif %}
            </div>
        {% endif %}
    </div>

    <!-- Ph·∫ßn D·ª± ƒëo√°n t·ª´ Camera -->
    <div class="section">
        <h2>2Ô∏è‚É£ D·ª± ƒëo√°n t·ª´ Camera:</h2>

        <button id="start-camera">üé• B·∫≠t Camera</button>
        <button id="stop-camera" style="display:none;">üõë T·∫Øt Camera</button><br><br>

        <video id="webcam" autoplay playsinline width="320" height="240" style="display:none;"></video>
        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas><br>

        <button id="capture-btn" onclick="captureAndSend()">üì∏ Ch·ª•p & D·ª± ƒëo√°n</button>

        <div id="result" style="margin-top: 20px;">
            <h3>K·∫øt qu·∫£ d·ª± ƒëo√°n t·ª´ Camera:</h3>
            <div id="resultText"></div>
            <div class="result" id="camera-result"></div>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const startBtn = document.getElementById('start-camera');
        const stopBtn = document.getElementById('stop-camera');
        const captureBtn = document.getElementById('capture-btn');

        // B·∫≠t camera
        startBtn.addEventListener('click', () => {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.style.display = 'block';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    captureBtn.style.display = 'inline-block';
                })
                .catch(err => {
                    console.error("Kh√¥ng th·ªÉ b·∫≠t camera: ", err);
                    alert("Kh√¥ng th·ªÉ truy c·∫≠p camera.");
                });
        });

        // T·∫Øt camera
        stopBtn.addEventListener('click', () => {
            const stream = video.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.srcObject = null;
            video.style.display = 'none';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            captureBtn.style.display = 'none';
        });

        // Ch·ª•p ·∫£nh t·ª´ webcam v√† g·ª≠i t·ªõi Flask
        function captureAndSend() {
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('file', blob, 'webcam.jpg');

                fetch('/predict', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    const resultDiv = document.getElementById('camera-result');
                    const resultText = document.getElementById('resultText');

                    if (data.prediction) {
                        let html = `<h3>K·∫øt qu·∫£ d·ª± ƒëo√°n:</h3><ul>`;
                        data.prediction.forEach(([label, prob]) => {
                            html += `<li>üî§ <strong>${label}</strong> ‚Äì ${prob.toFixed(2)}%</li>`;
                        });
                        html += `</ul>`;
                        html += `<h4>·∫¢nh sau x·ª≠ l√Ω:</h4><img src="${data.image_url}?t=${new Date().getTime()}" width="200">`;
                        resultDiv.innerHTML = html;
                        resultText.innerHTML = '';
                    } else {
                        resultText.innerHTML = `<p style="color:red;">üö´ Kh√¥ng ph√°t hi·ªán ng√¥n ng·ªØ k√Ω hi·ªáu.</p>`;
                        resultDiv.innerHTML = '';
                    }

                    const stream = video.srcObject;
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    video.srcObject = null;
                    video.style.display = 'none';
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    captureBtn.style.display = 'none';
                })
                .catch(error => {
                    console.error('L·ªói khi g·ª≠i y√™u c·∫ßu:', error);
                    document.getElementById('resultText').innerHTML = `<p style="color:red;">üö´ ƒê√£ c√≥ l·ªói x·∫£y ra khi d·ª± ƒëo√°n.</p>`;
                });
            }, 'image/jpeg', 0.95);
        }

        // Toggle Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
        }
    </script>
</body>
</html>
